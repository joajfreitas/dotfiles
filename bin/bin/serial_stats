#!/usr/bin/env python3

import serial, sys
from datetime import datetime

ser = serial.Serial(sys.argv[1])  # open serial port
print(">", ser.name)         # check which port was really used

message_count = 0
num_messages = 0

start = datetime.today()
try:
    while True:
        line = ser.readline().decode('utf-8')
        dlc = 2*len(line.split(',')) - 4
        if dlc < 0:
            continue
        
        message_count += 1
        if dlc == 2:
            print(line)
            sid, dlc, data0 = line.split(',')
            message_count -= 1
            if sid == "1":
                num_messages += int(data0)
                continue

        #print(line)
        #print(message_count)
        #print('\n')

except KeyboardInterrupt:
    print("")
    end = datetime.today()
    time = (end-start).microseconds
    print('Time: ', time/1000, 's')
    time = (end-start).seconds
    print('freq', message_count / time)
    print('Messages received:', message_count)
    print('CAN messages sent: ', num_messages)
    print('Messages lost:', abs(message_count-num_messages) / num_messages * 100)
    


ser.close()
